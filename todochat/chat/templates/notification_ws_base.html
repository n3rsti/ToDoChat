<script>
    let wsStart = 'ws://'
    if (window.location.protocol === 'https:') {
        wsStart = 'wss://'
    }

    function connectToPersonalWS() {
        const personalWS = new ReconnectingWebSocket(
            wsStart
            + window.location.host
            + '/ws/{{ request.user }}/'
        );
        personalWS.onmessage = function (e) {
            console.log(e.data);
        }
    }

    connectToPersonalWS();


    // Base for every view using these functions. Contains websocket connection + websocket.send
    let invitationBase = {
        invite: function (btn) {
            let invited = btn.dataset.user;
            let invited_img = btn.dataset.user_img;

            const inviteWS = new ReconnectingWebSocket(
                wsStart
                + window.location.host
                + `/ws/${invited}/`
            );
            inviteWS.onopen = function () {
                inviteWS.send(JSON.stringify({
                    'type': 'invitation',
                    'invited': invited,
                    'invited_img': invited_img,
                    'inviting': '{{ request.user }}'
                }))
                inviteWS.close();
            }
        },
        cancel: function (btn) {
            let invited = btn.dataset.user;
            let friend = invited;
            let invited_img = btn.dataset.user_img;
            let inviting = "{{ request.user }}";
            if (btn.classList.contains("reject_button")) {
                [invited, inviting] = [inviting, invited]
                btn.parentNode.parentNode.querySelector(".accept").style.display = "none";
            }
            if(btn.classList.contains("swap")){
                [invited, inviting] = [inviting, invited];
            }

            const inviteWS = new ReconnectingWebSocket(
                wsStart
                + window.location.host
                + `/ws/${friend}/`
            );
            inviteWS.onopen = function () {
                inviteWS.send(JSON.stringify({
                    'type': 'cancel_invitation',
                    'invited': invited,
                    'invited_img': invited_img,
                    'inviting': inviting
                }))
                inviteWS.close();
            }
        },
        accept: function (btn) {
            let inviting = btn.dataset.user;
            let invited_img = btn.dataset.user_img;
            let invited = "{{ request.user }}";

            const inviteWS = new ReconnectingWebSocket(
                wsStart
                + window.location.host
                + `/ws/${inviting}/`
            );
            inviteWS.onopen = function () {
                inviteWS.send(JSON.stringify({
                    'type': 'accept_invitation',
                    'invited': invited,
                    'invited_img': invited_img,
                    'inviting': inviting
                }))
                inviteWS.close();
            }
        }
    }


    let searchInvitationFunctions = {
        invite: function (btn) {
            invitationBase.invite(btn);
            btn.innerText = "Cancel";
            btn.classList.remove("btn-primary");
            btn.classList.add("btn-danger");
            let old_element = btn;
            let new_element = old_element.cloneNode(true);
            old_element.parentNode.replaceChild(new_element, old_element);
            new_element.addEventListener("click", function () {
                searchInvitationFunctions.cancel(new_element);
            });
        },
        cancel: function (btn) {
            invitationBase.cancel(btn);
            btn.innerText = "Invite";
            btn.classList.remove("btn-danger");
            btn.classList.add("btn-primary");
            let old_element = btn;
            let new_element = old_element.cloneNode(true);
            old_element.parentNode.replaceChild(new_element, old_element);
            new_element.addEventListener("click", function () {
                searchInvitationFunctions.invite(new_element);
            });
        },
        accept: function (btn) {
            invitationBase.accept(btn);
            let profile_link = document.createElement("a");
            let inviting = btn.dataset.user;
            profile_link.innerText = "Message";
            profile_link.classList.add("btn");
            profile_link.classList.add("btn-primary");
            profile_link.href = `/profile/${inviting}/chat`;
            btn.parentNode.parentNode.append(profile_link);
            btn.parentNode.parentNode.removeChild(document.querySelector(".reject"));
            btn.parentNode.parentNode.removeChild(document.querySelector(".accept"));

        }
    }

    let profileInvitation = {
        cancel: function (btn) {
            invitationBase.cancel(btn);
            btn.innerText = "Add friend"
            btn.classList.add("btn-primary");
            btn.classList.remove("btn-danger");
            let old_element = btn;
            let new_element = old_element.cloneNode(true);
            old_element.parentNode.replaceChild(new_element, old_element);
            new_element.addEventListener("click", function () {
                profileInvitation.invite(new_element);
            });
        },
        invite: function (btn) {
            invitationBase.invite(btn);
            btn.innerText = "Cancel invitation";
            btn.classList.remove("btn-primary");
            btn.classList.add("btn-danger");
            let old_element = btn;
            let new_element = old_element.cloneNode(true);
            old_element.parentNode.replaceChild(new_element, old_element);
            new_element.addEventListener("click", function () {
                profileInvitation.cancel(new_element);
            });
        }
    }
    let invitationsListFunctions = {
        reject: function (btn) {
            invitationBase.cancel(btn);
            btn.innerText = "Rejected";
            btn.classList.remove("btn-primary");
            btn.classList.add("btn-danger");
            btn.disabled = true;
            document.querySelector('.accept_invite_friend_button').remove();
            let old_element = btn;
            let new_element = old_element.cloneNode(true);
            old_element.parentNode.replaceChild(new_element, old_element);
        },
        accept: function (btn) {
            invitationBase.accept(btn);
            btn.innerText = "Accepted";
            btn.classList.remove("btn-primary");
            btn.classList.add("btn-success");
            btn.disabled = true;
            document.querySelector('.reject_invite_friend_button').remove();
            let old_element = btn;
            let new_element = old_element.cloneNode(true);
            old_element.parentNode.replaceChild(new_element, old_element);
        }
    }

    // Used in user_search.html
    let user_searchListeners = {
        invitationEventListeners: function () {
            $('.invite_friend_button').click(function (event) {
                event.preventDefault();
                searchInvitationFunctions.invite(this);
            })
        },
        cancelInvitationEventListeners: function () {
            $('.cancel_invite_friend_button').click(function (event) {
                event.preventDefault();
                searchInvitationFunctions.cancel(this);
            })
        },
        acceptInvitationEventListeners: function () {
            $('.accept_invite_friend_button').click(function (event) {
                event.preventDefault();
                searchInvitationFunctions.accept(this);
            })
        }
    }

    let profileListeners = {
        addFriendEventListeners: function () {
            $('.invite_friend_button').click(function (event) {
                event.preventDefault();
                profileInvitation.invite(this);
            })
        },
        cancelInvitationEventListeners: function () {
            $('.cancel_invite_friend_button').click(function (event) {
                event.preventDefault();
                profileInvitation.cancel(this);
            })
        }
    }

    let invitationsListListeners = {
        reject: function () {
            $('.reject_friend_button').click(function (event) {
                event.preventDefault();
                invitationsListFunctions.reject(this);
            })
        },
        accept: function () {
            $('.accept_invite_friend_button').click(function (event) {
                event.preventDefault();
                invitationsListFunctions.accept(this);
            })
        }
    }
    function resetChannelNotifications(channel_id) {
        localStorage.setItem(`${channel_id}_notifications`, "0");
        document.querySelector(`.groups__li[data-channel="${channel_id}"] .badge`).style.opacity = 0;
    }

    function showChannelNotificationBadge(channel_id) {
        document.querySelector(`.groups__li[data-channel="${channel_id}"] .badge`).style.opacity = 1;
        document.querySelector(`.groups__li[data-channel="${channel_id}"] .badge`).innerText = localStorage[`${channel_id}_notifications`]
    }

    function showServerNotificationBadge(server_id) {
        document.querySelector(`.groups__li[data-server="${server_id}"] .badge`).style.opacity = 1;
        document.querySelector(`.groups__li[data-server="${server_id}"] .badge`).innerText = localStorage[`${server_id}_notifications`]
    }

    function checkNotificationCounter() {
        {% for server in user.server_set.all %}
            {% if server != object %}
                if (localStorage["{{ server.id }}_notifications"] !== "0" && !isNaN(localStorage["{{ server.id }}_notifications"])) {
                    showServerNotificationBadge("{{ server.id }}");
                }
            {% endif %}
        {% endfor %}
    }

    function checkServerCounter() {
        {% for channel in server.channel_set.all %}
            if (localStorage["{{ channel.id }}_notifications"] !== "0" && !isNaN(localStorage["{{ channel.id }}_notifications"])) {
                showChannelNotificationBadge("{{ channel.id }}");
            }
        {% endfor %}
    }

    function checkUserNotificationsCounter() {
        {% for channel in request.user.users_chat.all %}
            if (localStorage["{{ channel.id }}_notifications"] !== "0" && !isNaN(localStorage["{{ channel.id }}_notifications"])) {
                showChannelNotificationBadge("{{ channel.id }}");
            }
        {% endfor %}
    }

    checkUserNotificationsCounter();

    function increment_notification_count(server_id, channel_id) {
        let server_badge = document.querySelector(`.groups__li[data-channel="${channel_id}"] .badge`);
        if (server_id !== "{{ server.id }}") {
            server_badge = document.querySelector(`.groups__li[data-server="${server_id}"] .badge`);
        }
        // "" value for opacity is opacity 0
        let LSNotificationsCounter = localStorage[`${server_id}_notifications`];
        let LSChannelNotificationsCounter = localStorage[`${channel_id}_notifications`];
        if (server_badge.style.opacity === "") {
            server_badge.style.opacity = 1;
        }
        if (LSNotificationsCounter) {
            localStorage.setItem(`${server_id}_notifications`, parseInt(LSNotificationsCounter) + 1);
            if (LSChannelNotificationsCounter) {
                localStorage.setItem(`${channel_id}_notifications`, parseInt(LSChannelNotificationsCounter) + 1);
            } else {
                localStorage.setItem(`${channel_id}_notifications`, "1");
            }
        } else {
            localStorage.setItem(`${server_id}_notifications`, "1");
            localStorage.setItem(`${channel_id}_notifications`, "1");

        }
    }

    function incrementUserNotificationCount(channel_id) {
        let profile_badge = document.querySelector(`.groups__li[data-channel="${channel_id}"] .badge`);
        let LSChannelNotificationsCounter = localStorage[`${channel_id}_notifications`];
        if (LSChannelNotificationsCounter) {
            localStorage.setItem(`${channel_id}_notifications`, parseInt(localStorage[`${channel_id}_notifications`]) + 1);
        } else {
            localStorage.setItem(`${channel_id}_notifications`, "1");
        }
        if (profile_badge.style.opacity === "") {
            profile_badge.style.opacity = 1;
        }
    }
    {% if is_room_html is not True %}
        {% for channel in request.user.users_chat.all %}
            const userServerSocket{{ forloop.counter }} = new ReconnectingWebSocket(
                wsStart
                + window.location.host
                + '/ws/chat_notifications/'
                + '{{ channel.id }}/'
            );
            userServerSocket{{ forloop.counter }}.onmessage = function (e) {
                let data = JSON.parse(e.data);
                let channel_id = data.channel_id
                if (data.author !== "{{ request.user }}" && Number(localStorage['last_msg_id']) !== data.msg_id) {
                    localStorage.setItem('last_msg_id', data.msg_id);
                    incrementUserNotificationCount(channel_id);
                }

                let profile_badge = document.querySelector(`.groups__li[data-channel="${channel_id}"] .badge`);
                profile_badge.innerText = Number(profile_badge.innerText) + 1;
            }
        {% endfor %}
    {% else %}
        {% for channel in request.user.users_chat.all %}
            {% if channel != object %}
                const userServerSocket{{ forloop.counter }} = new ReconnectingWebSocket(
                    wsStart
                    + window.location.host
                    + '/ws/chat_notifications/'
                    + '{{ channel.id }}/'
                );
                userServerSocket{{ forloop.counter }}.onmessage = function (e) {
                    let data = JSON.parse(e.data);
                    let channel_id = data.channel_id
                    if (data.author !== "{{ request.user }}" && Number(localStorage['last_msg_id']) !== data.msg_id) {
                        localStorage.setItem('last_msg_id', data.msg_id);
                        incrementUserNotificationCount(channel_id);
                    }
                    let profile_badge = document.querySelector(`.groups__li[data-channel="${channel_id}"] .badge`);
                    profile_badge.innerText = Number(profile_badge.innerText) + 1;
                }
            {% endif %}
        {% endfor %}
    {% endif %}
</script>